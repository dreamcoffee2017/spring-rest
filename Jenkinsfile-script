#!/usr/bin/env groovy
def ENVIRONMENT = 'ppe'
def GIT_URL = 'https://github.com/dreamcoffee2017/spring-boot-demo.git'
def PROPS
def REGION_SHORT

node {
    properties([
        buildDiscarder(logRotator(numToKeepStr: '3')),
        disableResume(),
        parameters([
            extendedChoice(
                name: 'TARGET_REGION',
                type: 'PT_SINGLE_SELECT',
                propertyFile: "${WORKSPACE}/src/main/resources/application.properties",
                propertyKey: 'params.region',
                description: 'Target BAW/ODM region'
            ),
            gitParameter(
                name: 'TAG',
                type: 'PT_TAG',
                selectedValue: 'NONE',
                defaultValue: 'master'
            )
        ])
    ])

    timestamps {
        stage ('Checkout') {
            checkout([
                    $class: 'GitSCM',
                    branches: [[name: "${params.TAG ?: 'master'}"]],
                    extensions: [[$class: 'CleanCheckout']],
                    userRemoteConfigs: [[url: GIT_URL]]
            ])

            PROPS = readProperties file: 'src/main/resources/application.properties'
            def propsEnv = readProperties file: "src/main/resources/application-${ENVIRONMENT}.properties"
            PROPS.putAll(propsEnv)
            REGION_SHORT = PROPS["aws.region.${params.TARGET_REGION}.shortname"]
            println(REGION_SHORT)
        }
    }
}